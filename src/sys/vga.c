#include <system.h>
#include <vga.h>

unsigned char mode00h[] = 
{
	/*	MISC */
	0x63,
	/*	SEQ */
	0x03, 0x09, 0x03, 0x00, 0x02,
	/*	GC */
	0x2D, 0x27, 0x28, 0x90, 0x2B, 0xA0, 
	0xBF, 0x1F, 0x00, 0xC7, 0x06, 0x07, 
	0x00, 0x00, 0x00, 0x31, 0x9C, 0x8E,
	0x8F, 0x14, 0x1F, 0x96, 0xB9, 0xA3,
	0xFF,
	/*	GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 
	0x0E, 0x00, 0xFF,
	/*	GC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 
	0x06, 0x07, 0x10, 0x11, 0x12, 0x13, 
	0x14, 0x15, 0x16, 0x17, 0x08, 0x00,
	0x0F, 0x00, 0x00,
};

unsigned char mode13h[] = 
{
		/*	MISC */
		0x63,
		/*	SEQ*/
		0x03, 0x01, 0x0F, 0x00, 0x0E,
		/*	CRTC */
		0x5F, 0x4F, 0x50, 0x82, 0x24, 0x80,
		0xBF, 0x1F, 0x00, 0x41, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x31, 0x9C, 0x8E,
		0x8F, 0x28, 0x40, 0x96, 0xB9, 0xA3,
		0xFF,
		/*	GC */
		0x00, 0x00, 0x00, 0x00, 0x00, 0x40,
		0x50, 0x0F, 0xFF,
		/*	AC */
		0x00, 0x01, 0x02, 0x03, 0x04, 0x05,
		0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B,
		0x0C, 0x0D, 0x0E, 0x0F, 0x41, 0x00,
		0x0F, 0x00, 0x00,
};

void vga_update_registers(unsigned char *r)
{
	int i;

	/*	write Miscellaneous register */
	outb(VGA_MISC_WRITE, *r);
	r++;

	/*	write Sequencer registers */
	for ( i = 0; i < VGA_NUM_SEQ_REGS ; i++ ) {
		outb(VGA_SEQ_INDEX, i);
		outb(VGA_SEQ_DATA, *r);
		r++;
	}

	/* unlock CRTC registers */
	outb(VGA_CRTC_INDEX, 0x03);
	outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) | 0x80);
	outb(VGA_CRTC_INDEX, 0x11);
	outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) & ~0x80);
	/* make sure they remain unlocked */
	r[0x03] |= 0x80;
	r[0x11] &= ~0x80;

	/*	wirte CRTC registers */
	for ( i = 0; i < VGA_NUM_CRTC_REGS ; i++ ) {
		outb(VGA_CRTC_INDEX, i);
		outb(VGA_CRTC_DATA, *r);
		r++;
	}

	/*	write Graphic Controller registers */
	for ( i = 0; i < VGA_NUM_GC_REGS ; i++ ) {
		outb(VGA_GC_INDEX, i);
		outb(VGA_GC_DATA, *r);
		r++;		// next register
	}

	/*	write Attribute Controller registers*/
	for ( i = 0; i < VGA_NUM_AC_REGS ; i++ ) {
		inb(VGA_INSTAT_READ);
		outb(VGA_AC_INDEX, i);
		outb(VGA_AC_WRITE, *r);
		r++;
	}

	/*	enable video mode */
	outb(VGA_AC_WRITE, 0x20);
}

void config_vga_mode(int mode)
{
	switch(mode){
	case 0x00:
		vga_update_registers(mode00h);
		break;
	case 0x13:
		vga_update_registers(mode13h);
		break;
	default:
		break;
	}
}
